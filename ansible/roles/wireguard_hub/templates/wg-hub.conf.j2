[Interface]
Address = {{ hub_wg_ip }}/24
ListenPort = {{ wg_listen_port }}
PrivateKey = {{ hub_wg_privkey_runtime }}
MTU = {{ wg_mtu }}

{# Собираем список всех пиров из групп #}
{% set vpn_hosts    = groups['vpn']            | default([]) %}
{% set probe_hosts  = groups['ru_zondes']      | default([]) %}
{% set backup_hosts = groups['backup_clients'] | default([]) %}
{% set all_hosts    = (vpn_hosts + probe_hosts + backup_hosts) | unique %}

{# Рендерим только валидные пиры: есть IP и паблик-ключ, и это не сам хаб #}
{% for h in all_hosts %}
  {% set node_ip  = hostvars[h].wg_ip | default(hostvars[h].ansible_host | default('')) %}
  {% set node_pub = (node_pubmap[h] if (node_pubmap is defined and h in node_pubmap) else hostvars[h].wg_pubkey | default('')) %}
  {% set node_name = hostvars[h].node_name | default(h) %}

  {% if node_ip and (node_pub | length > 0) and (node_ip != hub_wg_ip) %}
[Peer]
# {{ node_name }}
PublicKey = {{ node_pub }}
AllowedIPs = {{ node_ip }}/32
PersistentKeepalive = 25

  {% endif %}
{% endfor %}
