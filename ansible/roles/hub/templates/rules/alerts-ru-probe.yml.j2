groups:
- name: alerts-ru-probe
  rules:
  # WG: падение uplink относительно 7-дневной базы
  - alert: RUWGThroughputUplinkDrop
    expr: |
      (ru:wg:uplink_ratio:latest_vs_baseline7d < 0.7)
      and on (name) (ru:wg:last_run_age_seconds < 36000)
    labels:
      severity: warning
    annotations:
      summary: |
        {% raw %}Падение WG uplink на {{ $labels.name }} (>30% относительно 7-дневной базы){% endraw %}
      description: |
        Текущая сквозная скорость uplink заметно ниже исторической (ratio < 0.7).
  
  # WG: падение downlink относительно 7-дневной базы
  - alert: RUWGThroughputDownlinkDrop
    expr: |
      (ru:wg:downlink_ratio:latest_vs_baseline7d < 0.7)
      and on (name) (ru:wg:last_run_age_seconds < 36000)
    labels:
      severity: warning
    annotations:
      summary: |
        {% raw %}Падение WG downlink на {{ $labels.name }} (>30% относительно 7-дневной базы){% endraw %}
      description: |
        Текущая сквозная скорость downlink заметно ниже исторической (ratio < 0.7).

  # WG-проба не обновлялась (staleness)
  - alert: RUWGProbeStale
    expr: |
      (ru:wg:last_run_age_seconds > 36000)
      and
      ru:wg:last_run_age_seconds
    for: 30m
    labels:
      severity: warning
    annotations:
      summary: |
        {% raw %}WG iperf-проба не обновлялась > 10 часов — {{ $labels.name }}{% endraw %}
      description: |
        {% raw %}Текущее отставание: {{ humanizeDuration $value }}.{% endraw %}