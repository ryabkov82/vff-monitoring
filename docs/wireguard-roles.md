# WireGuard —Ä–æ–ª–∏ (`wireguard_hub`, `wireguard_node`): –ø–∞–º—è—Ç–∫–∞

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –∫—Ä–∞—Ç–∫–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ —Ä–æ–ª—è–º WireGuard. **–ü–æ—à–∞–≥–æ–≤—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ —É–∑–ª–∞ –≤—ã–Ω–µ—Å–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π runbook:**  
üëâ —Å–º. [docs/NEW_NODE.md](docs/NEW_NODE.md).

---

## –ß—Ç–æ –≥–¥–µ

- `ansible/roles/wireguard_hub/tasks/main.yml` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ **—Ö–∞–±–∞**: –∫–ª—é—á–∏, —Å–±–æ—Ä pubkey'–µ–≤ —É–∑–ª–æ–≤, —Ä–µ–Ω–¥–µ—Ä `/etc/wireguard/<iface>.conf`, UFW, –∑–∞–ø—É—Å–∫ `wg-quick`.
- `ansible/roles/wireguard_node/tasks/main.yml` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ **—É–∑–ª–∞**: –∫–ª—é—á–∏, –ø–æ–ª—É—á–µ–Ω–∏–µ pubkey —Ö–∞–±–∞, —Ä–µ–Ω–¥–µ—Ä `/etc/wireguard/<iface>.conf`, –∑–∞–ø—É—Å–∫ `wg-quick`.

–†–æ–ª–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ `ansible/site.yml` –∏ —É–¥–æ–±–Ω–µ–µ –∑–∞–ø—É—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ —Ü–µ–ª–∏ Makefile (—Å–º. –Ω–∏–∂–µ).

---

## –¢–µ–≥–∏ —Ä–æ–ª–µ–π

- `wg` ‚Äî –æ–±—â–∏–π —Ç–µ–≥ –¥–ª—è WG-–∑–∞–¥–∞—á (—Ö–∞–± –∏ —É–∑–ª—ã).
- `wg_hub` ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ —Ä–æ–ª–∏ `wireguard_hub`.
- `wg_node` ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ —Ä–æ–ª–∏ `wireguard_node`.

–ü—Ä–∏–º–µ—Ä—ã:
```bash
ansible-playbook -i ansible/hosts.ini ansible/site.yml --limit hub --tags wg_hub
ansible-playbook -i ansible/hosts.ini ansible/site.yml --limit vpn --tags wg_node
```

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —É–∑–ª–æ–≤ –∑–∞–¥–∞—ë–º —á–µ—Ä–µ–∑ `vpn_nodes` –≤ `group_vars/all.yml`. –î–ª—è —Ö–∞–±–∞ ‚Äî —á–µ—Ä–µ–∑ `group_vars/hub/*.yml`.

–û–±—â–∏–µ (–º–æ–≥—É—Ç –ª–µ–∂–∞—Ç—å –≤ `group_vars/all.yml`):
```yaml
wg_iface: wgmon0
wg_listen_port: 51821
wg_mtu: 1280
```

–•–∞–± (–≤ `group_vars/hub/main.yml` –∏–ª–∏ vault):
```yaml
# –í–∞—Ä–∏–∞–Ω—Ç A: BYO-–∫–ª—é—á –∏–∑ Vault (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω ‚Äî –ø–∞—Ä–∞ –∫–ª—é—á–µ–π –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ç—Å—è)
hub_wg_private_key: !vault |
  <—Å–µ–∫—Ä–µ—Ç>

# (–æ–ø—Ü.) –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Ö–∞–±–∞, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–¥–∞–≤–∞—Ç—å –µ–≥–æ –±–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è:
hub_wg_pubkey: "..."  # –æ–±—ã—á–Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
```

–£–∑–ª—ã ‚Äî —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ `vpn_nodes` (–≤ `group_vars/all.yml`):
```yaml
vpn_nodes:
  - name: "nl-ams-1"            # –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å inventory_hostname
    wg_ip: "10.77.0.2"          # WG /32 –∞–¥—Ä–µ—Å —É–∑–ª–∞ (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
    instance: "10.77.0.2:9100"  # –∞–¥—Ä–µ—Å —Ç–∞—Ä–≥–µ—Ç–∞ node_exporter –¥–ª—è Prometheus
    role: "vpn"
  # - name: "nl-ams-2"
  #   wg_ip: "10.77.0.3"
  #   instance: "10.77.0.3:9100"
  #   role: "vpn"
```

> –†–æ–ª—å `wireguard_node` **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç** `host_vars`: –æ–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç `wg_ip` –ø–æ –∑–∞–ø–∏—Å–∏ –≤ `vpn_nodes`, –≥–¥–µ `name == inventory_hostname`. –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Äî –∑–∞–¥–∞—á–∞ —É–ø–∞–¥—ë—Ç —Å –ø–æ–Ω—è—Ç–Ω–æ–π –æ—à–∏–±–∫–æ–π (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª –≤ `vpn_nodes`).

---

## –ü–æ—Ç–æ–∫ —Ä–æ–ª–∏ `wireguard_hub`

1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ (`apt`).  
2. –ö–∞—Ç–∞–ª–æ–≥ `/etc/wireguard` (0750).  
3. –ö–ª—é—á–∏:
   - –µ—Å–ª–∏ `hub_wg_private_key` –∑–∞–¥–∞–Ω ‚Äî –ø–∏—à–µ–º `.key`, —Å—á–∏—Ç–∞–µ–º `.pub`;
   - –∏–Ω–∞—á–µ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä—É (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ).  
4. –ü—Ä–∞–≤–∞ –Ω–∞ –∫–ª—é—á–∏: `.key` ‚Äî 0600, `.pub` ‚Äî 0644.  
5. –°—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ —Ñ–∞–∫—Ç `hub_wg_privkey_runtime` (–Ω–µ –ª–æ–≥–∏—Ä—É–µ–º).  
6. –°–æ–±–∏—Ä–∞–µ–º pubkey'–∏ —É–∑–ª–æ–≤ (delegated slurp) ‚Üí `vpn_pubmap`.  
7. –†–µ–Ω–¥–µ—Ä–∏–º `/etc/wireguard/<iface>.conf` –∏–∑ `wg-hub.conf.j2` ‚Üí notify: `Restart wg-quick`.  
8. (–ï—Å–ª–∏ –µ—Å—Ç—å UFW) –æ—Ç–∫—Ä—ã–≤–∞–µ–º UDP-–ø–æ—Ä—Ç.  
9. –í–∫–ª—é—á–∞–µ–º –∏ —Å—Ç–∞—Ä—Ç—É–µ–º `wg-quick@<iface>`.

---

## –ü–æ—Ç–æ–∫ —Ä–æ–ª–∏ `wireguard_node`

1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ (`apt`).  
2. –ö–∞—Ç–∞–ª–æ–≥ `/etc/wireguard` (0750).  
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä—ã –∫–ª—é—á–µ–π (–µ—Å–ª–∏ `.key` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç) + –ø—Ä–∞–≤–∞ (0600/0644).  
4. –ß–∏—Ç–∞–µ–º —Å–≤–æ–π pubkey –≤ `node_wg_pubkey`.  
5. –û–ø—Ä–µ–¥–µ–ª—è–µ–º `wg_ip` (–∏–ª–∏ –±–µ—Ä—ë–º –∏–∑ `vpn_nodes`).  
6. –ß–∏—Ç–∞–µ–º pubkey —Ö–∞–±–∞ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º `hub_wg_pubkey`.  
7. –†–µ–Ω–¥–µ—Ä–∏–º `/etc/wireguard/<iface>.conf` –∏–∑ `wg-node.conf.j2` ‚Üí notify: `Restart wg-quick`.  
8. –í–∫–ª—é—á–∞–µ–º –∏ —Å—Ç–∞—Ä—Ç—É–µ–º `wg-quick@<iface>`.

---

## Makefile (–æ—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏)

```bash
# –†–æ–ª—å —É–∑–ª–∞ / –≤—Å–µ–π –≥—Ä—É–ø–ø—ã vpn
make wg-node
# –†–æ–ª—å —Ö–∞–±–∞
make wg-hub
# –•–∞–± + —É–∑–ª—ã
make wg
# –°—Ç–∞—Ç—É—Å—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –Ω–∞ —Ö–∞–±–µ –∏ —É–∑–ª–∞—Ö
make wg-status

# –û–Ω–±–æ—Ä–¥–∏–Ω–≥ —É–∑–ª–∞ (—à–∞–≥–∏ 1‚Äì3) ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ docs/NEW_NODE.md
make add-node HOST=<hostname>
# –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ (—à–∞–≥ 7 runbook'–∞)
make add-node-check HOST=<hostname> [WG_IP=10.77.0.X] [NODE_PORT=9100]
# –ü–æ–ª–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ + –ø—Ä–æ–≤–µ—Ä–∫–∞
make add-node-all HOST=<hostname> [WG_IP=10.77.0.X] [NODE_PORT=9100]
```

---

## –û—Ç–ª–∞–¥–∫–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –°–º–æ—Ç—Ä–∏—Ç–µ `wg show`, `systemctl status wg-quick@wgmon0`, `journalctl -u wg-quick@wgmon0 -e`.  
- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—á–∞—Ç–∞—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö (`no_log: true`), –ª–µ–∂–∞—Ç –Ω–∞ —Ö–æ—Å—Ç–∞—Ö —Å –ø—Ä–∞–≤–∞–º–∏ 0600.  
- –ï—Å–ª–∏ UFW –≤–∫–ª—é—á—ë–Ω ‚Äî –ø—Ä–∞–≤–∏–ª–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ—Ä—Ç–∞ WG –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.  
- –î–ª—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤ –±–µ–∑ APT –¥–æ–±–∞–≤—å—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–∞—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤.

---

_–î–æ–∫—É–º–µ–Ω—Ç: `docs/wireguard-roles.md`. –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥: `docs/NEW_NODE.md`._
