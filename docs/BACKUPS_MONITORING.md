# Интеграция бэкапов в систему мониторинга VFF (backup-клиенты + метрики)

Документ описывает **как подключать бэкап-клиенты к мониторингу** и **как мониторинг обрабатывает метрики бэкапов**.  
Сама система бэкапов разворачивается отдельно и публикует метрики вида:

```
backup_last_run_timestamp_seconds{backup_job="shm"} 1739491210
backup_last_duration_seconds{backup_job="shm"} 5
backup_last_status{backup_job="shm"} 0
backup_last_size_bytes{backup_job="shm"} 246751   # опц., если >0
```

> Используется метка **`backup_job`**, а не `job` — чтобы не конфликтовать с меткой `job`, которую добавляет Prometheus при сборе.

---

## 1) Предпосылки

- Хаб мониторинга развёрнут (Prometheus/Alertmanager/Grafana) и настроен WireGuard-хаб.
- На Ansible‑контроллере настроен SSH‑доступ к хостам.
- На бэкап‑клиентах установлен `node_exporter`, а бэкап‑проект пишет `.prom`‑файлы в каталог textfile (обычно `/var/lib/node_exporter/textfile`, права `0644`, каталог читается пользователем `node_exporter`).

---

## 2) Инвентори и переменные

**`ansible/hosts.ini`** — добавьте хосты в группу `[backup_clients]`. По желанию можно указать “красивое” имя через `backup_job_name` для отображения в дашбордах/алертах.

**`ansible/host_vars/<host>.yml`** — обязательно задайте:
- `wg_ip`: адрес в WG‑сети (используется для таргетов Prometheus и пиров WG);
- (опц.) `node_name`: имя узла по умолчанию для меток/панелей;
- (опц.) `backup_job_name`: отображаемое имя **именно** для бэкапов (если нужно отдельное).

> Общая роль узла (`prom_role`) может быть любой (vpn/probe/…); для бэкап‑таргетов роль в метках будет **принудительно** `backup`.

---

## 3) Онбординг backup‑клиентов (что делает плейбук и шорткаты)

Плейбук **`ansible/playbooks/backup.yml`** нацеливается на группу `[backup_clients]` и выполняет:
- установку и настройку **WireGuard‑клиента** на хосте;
- установку и запуск **node_exporter** на `WG_IP:9100` c включённым textfile‑коллектором.

Для удобства предусмотрены две make‑задачи:
- **add‑backup‑client** — выполняет три шага для **одного** хоста:  
  1) плейбук `backup.yml` на клиенте; 2) обновление пиров на хабе; 3) применение бандла на хабе (перегенерация targets/rules и health, reload Prometheus).
- **add‑backup‑all** — делает то же самое для **всей** группы `[backup_clients]`.

> Имена задач приведены для ориентира; вызывать их можно из корня репозитория как обычные цели Makefile.

---

## 4) Интеграция в Prometheus (кратко)

- **Targets (file_sd)**: генерируется файл для бэкап‑клиентов, где таргеты — `WG_IP:9100`. В метках присутствуют:  
  `instance` (WG_IP:9100), `name` (из `backup_job_name` → `node_name` → `inventory_hostname`), `role="backup"`.
- **Scrape‑jobs**: общий job для всех нод **отбрасывает** метрики `backup_*`, а специальный job **собирает только** `backup_*`. Это устраняет дубли.
- **Recording‑rules**: агрегируют основные метрики бэкапов (статус, возраст последнего запуска, размер, длительность) **только** по таргетам с `role="backup"` и публикуют удобные для графан‑панелей серии вида `backup:last_*`. Детали выражений в шаблоне правил роли `hub`.
- **Alerts**: определены правила “Failed / Stale / ZeroSize / TooSmall / LongDuration”; они используют записанные серии `backup:last_*` и метку `name` для человеческого текста в нотификациях.

---

## 5) Проверка

- **Таргеты**: в веб‑интерфейсе Prometheus проверьте, что в секции **backup** таргеты в состоянии `UP`.
- **Метрики**: убедитесь, что в `/metrics` на клиенте присутствуют строки `backup_*`, а в Prometheus они видны c меткой `role="backup"`.
- **Панели**: в Grafana дашборд “Backups” (если включён в репо) использует записи `backup:last_*` и отображает статус, возраст, размер и длительность последнего бэкапа.

---

## 6) Типичные проблемы и решения

- **Таргет DOWN** — проверьте WG‑связность, firewall и что `node_exporter` слушает `WG_IP:9100`.
- **Метрик `backup_*` нет** — проверьте, что бэкап‑проект пишет `.prom` в корректный путь textfile и с правами `0644`.
- **Дублируются `backup_*`** — убедитесь, что общий job для нод действительно **отбрасывает** `backup_*`, а специальный backup‑job — **оставляет только** их. Также важно, чтобы бэкап‑скрипт использовал метку **`backup_job=`**, а не `job=`.
- **Неверное “имя” в алертах** — задайте `backup_job_name` в `[backup_clients]` или `node_name` в `host_vars/<host>.yml`.

---

## 7) Краткий чек‑лист

1. Добавьте хост в `[backup_clients]` и опишите его `wg_ip` (и, при необходимости, `node_name`/`backup_job_name`) в `host_vars`.
2. Запустите онбординг (для одного хоста или всей группы): плейбук на клиентах → обновление пиров на хабе → применение бандла на хабе.
3. Проверьте таргеты и метрики в Prometheus, а также отображение на дашборде Grafana.
